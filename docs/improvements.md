# å•æœºç‰ˆåŒæ­¥APIè¯„æµ‹æœºæ”¹è¿›æ–¹æ¡ˆ

## ğŸ“‹ æ”¹è¿›æ¦‚è§ˆ

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†é’ˆå¯¹å•æœºç‰ˆåŒæ­¥APIè¯„æµ‹æœºçš„æ‰€æœ‰æ”¹è¿›ç‚¹å’Œä½¿ç”¨æ–¹æ³•ã€‚

---

## ğŸ”´ å…³é”®é—®é¢˜ä¿®å¤

### 1. **æœ€ç»ˆè¯„æµ‹ç»“æœçŠ¶æ€è®¡ç®—é”™è¯¯** â­â­â­â­â­

**åŸé—®é¢˜**ï¼š
- æœ€ç»ˆçŠ¶æ€ç¡¬ç¼–ç ä¸º "AC"ï¼Œå³ä½¿æœ‰æµ‹è¯•ç‚¹å¤±è´¥ä¹Ÿè¿”å›AC
- `TotalTimeUsed` å’Œ `TotalMemUsed` æ²¡æœ‰æ­£ç¡®ç´¯åŠ å’Œç»Ÿè®¡

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
- å®ç°çŠ¶æ€ä¼˜å…ˆçº§æœºåˆ¶ï¼š`SE > CE > RE > TLE > MLE > WA > AC`
- æ­£ç¡®ç´¯åŠ æ‰€æœ‰æµ‹è¯•ç‚¹çš„æ—¶é—´
- ç»Ÿè®¡æ‰€æœ‰æµ‹è¯•ç‚¹ä¸­çš„æœ€å¤§å†…å­˜ä½¿ç”¨
- è®¡ç®—å¾—åˆ†ï¼ˆACæµ‹è¯•ç‚¹å æ¯”ï¼‰

**ä»£ç ä½ç½®**ï¼š`internal/service/task_improved.go`

```go
// çŠ¶æ€ä¼˜å…ˆçº§æ›´æ–°
finalStatus = updateFinalStatus(finalStatus, testCaseResult.Status)

// ç»Ÿè®¡ä¿¡æ¯æ›´æ–°
if testCaseResult.MemUsed > maxMemUsed {
    maxMemUsed = testCaseResult.MemUsed
}
totalTimeUsed += testCaseResult.TimeUsed
```

---

### 2. **æ·»åŠ å¹¶å‘æ§åˆ¶** â­â­â­â­â­

**åŸé—®é¢˜**ï¼š
- æ— é™åˆ¶å¹¶å‘å¯¼è‡´CPUèµ„æºç«äº‰
- å¤šä¸ªè¯„æµ‹ä»»åŠ¡åŒæ—¶è¿è¡Œå½±å“æ—¶é—´å’Œå†…å­˜æµ‹é‡å‡†ç¡®æ€§
- å¯èƒ½å¯¼è‡´ç³»ç»Ÿèµ„æºè€—å°½

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ä¿¡å·é‡ï¼ˆsemaphoreï¼‰é™åˆ¶æœ€å¤§å¹¶å‘è¯„æµ‹æ•°
- å¯é€šè¿‡é…ç½®æ–‡ä»¶è°ƒæ•´å¹¶å‘æ•°ï¼ˆå»ºè®®è®¾ç½®ä¸ºCPUæ ¸å¿ƒæ•°ï¼‰
- é˜Ÿåˆ—æ»¡æ—¶ç­‰å¾…æˆ–è¶…æ—¶è¿”å›

**é…ç½®**ï¼š
```yaml
judge:
  max_concurrent: 2  # æœ€å¤§å¹¶å‘è¯„æµ‹æ•°
```

**ä»£ç å®ç°**ï¼š
```go
var judgeSemaphore = make(chan struct{}, 2)  // æœ€å¤š2ä¸ªå¹¶å‘

// è·å–è¯„æµ‹æ§½ä½
select {
case judgeSemaphore <- struct{}{}:
    defer func() { <-judgeSemaphore }()
case <-time.After(30 * time.Second):
    return nil, fmt.Errorf("è¯„æµ‹é˜Ÿåˆ—å·²æ»¡ï¼Œè¯·ç¨åé‡è¯•")
}
```

---

### 3. **æ·»åŠ è¶…æ—¶ä¿æŠ¤** â­â­â­â­

**åŸé—®é¢˜**ï¼š
- æ•´ä¸ªè¯„æµ‹è¿‡ç¨‹æ²¡æœ‰æ€»è¶…æ—¶æ§åˆ¶
- å¯èƒ½å¯¼è‡´è¯·æ±‚é•¿æ—¶é—´é˜»å¡

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
- ä¸ºæ¯ä¸ªè¯„æµ‹ä»»åŠ¡è®¾ç½®æ€»è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤5åˆ†é’Ÿï¼‰
- ä½¿ç”¨ `context.WithTimeout` å®ç°è¶…æ—¶æ§åˆ¶
- è¶…æ—¶åè‡ªåŠ¨å–æ¶ˆè¯„æµ‹å¹¶è¿”å›é”™è¯¯

**é…ç½®**ï¼š
```yaml
judge:
  max_timeout: 300  # å•ä¸ªè¯„æµ‹æœ€å¤§è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
```

**ä»£ç å®ç°**ï¼š
```go
judgeCtx, cancel := context.WithTimeout(ctx, MaxJudgeTimeout)
defer cancel()

select {
case judgeResult := <-resultChan:
    return judgeResult, nil
case <-judgeCtx.Done():
    return nil, fmt.Errorf("è¯„æµ‹è¶…æ—¶ï¼ˆè¶…è¿‡%vï¼‰", MaxJudgeTimeout)
}
```

---

### 4. **å®Œå–„é”™è¯¯å¤„ç†** â­â­â­â­

**åŸé—®é¢˜**ï¼š
- é”™è¯¯å¤„ç†ä¸ä¸€è‡´ï¼Œæœ‰äº›é”™è¯¯è¿”å› `nil error`
- ç¼ºå°‘è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- æ²¡æœ‰åŒºåˆ†ç³»ç»Ÿé”™è¯¯å’Œç”¨æˆ·ä»£ç é”™è¯¯

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
- ç»Ÿä¸€é”™è¯¯å¤„ç†æ¨¡å¼
- ä½¿ç”¨ `fmt.Errorf` åŒ…è£…é”™è¯¯ï¼Œä¿ç•™é”™è¯¯é“¾
- æ·»åŠ  panic æ¢å¤æœºåˆ¶
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•

**ä»£ç å®ç°**ï¼š
```go
// å®‰å…¨è¿è¡Œæ²™ç®±ï¼Œæ•è·panic
func runSandboxSafe(runParams model.RunParams) (result *model.TestCaseResult, err error) {
    defer func() {
        if r := recover(); r != nil {
            err = fmt.Errorf("æ²™ç®±è¿è¡Œpanic: %v", r)
            result = &model.TestCaseResult{
                Status: model.StatusSE,
                Error:  fmt.Sprintf("ç³»ç»Ÿé”™è¯¯: %v", r),
            }
        }
    }()
    // ... æ²™ç®±è¿è¡Œé€»è¾‘
}
```

---

### 5. **å¢å¼ºå‚æ•°æ ¡éªŒ** â­â­â­

**åŸé—®é¢˜**ï¼š
- ç¼ºå°‘è¾“å…¥å‚æ•°æ ¡éªŒ
- å¯èƒ½å¯¼è‡´æ— æ•ˆå‚æ•°å¼•å‘ç³»ç»Ÿé”™è¯¯

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
- åœ¨è¯„æµ‹å¼€å§‹å‰æ ¡éªŒæ‰€æœ‰å¿…è¦å‚æ•°
- æ£€æŸ¥å‚æ•°èŒƒå›´çš„åˆç†æ€§
- æä¾›æ¸…æ™°çš„é”™è¯¯æç¤º

**ä»£ç å®ç°**ï¼š
```go
// æ ¡éªŒå¿…è¦å‚æ•°
if req.CodeFile == "" {
    return nil, fmt.Errorf("ä»£ç æ–‡ä»¶ä¸èƒ½ä¸ºç©º")
}
if len(req.CheckPoints) == 0 {
    return nil, fmt.Errorf("æµ‹è¯•ç”¨ä¾‹ä¸èƒ½ä¸ºç©º")
}
if req.CPULimit <= 0 || req.CPULimit > 60000 {
    return nil, fmt.Errorf("CPUæ—¶é—´é™åˆ¶æ— æ•ˆ: %d (åº”åœ¨1-60000msä¹‹é—´)", req.CPULimit)
}
```

---

## ğŸ†• æ–°å¢åŠŸèƒ½

### 6. **ç›‘æ§å’Œç»Ÿè®¡ç³»ç»Ÿ** â­â­â­â­â­

**åŠŸèƒ½è¯´æ˜**ï¼š
- å®æ—¶ç»Ÿè®¡è¯„æµ‹æŒ‡æ ‡
- æ€§èƒ½ç›‘æ§
- ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡
- ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

**æ–°å¢APIç«¯ç‚¹**ï¼š

#### å¥åº·æ£€æŸ¥
```bash
GET /health
```
è¿”å›æœåŠ¡å¥åº·çŠ¶æ€

#### è¯„æµ‹ç»Ÿè®¡
```bash
GET /metrics
```
è¿”å›è¯¦ç»†çš„è¯„æµ‹ç»Ÿè®¡ä¿¡æ¯ï¼š
```json
{
  "total_submissions": 1000,
  "success_submissions": 950,
  "ac_count": 800,
  "wa_count": 100,
  "avg_judge_time_ms": 1500,
  "cache_hit_rate": 85.5,
  "current_active": 2,
  "uptime_seconds": 3600
}
```

#### ç³»ç»Ÿä¿¡æ¯
```bash
GET /system
```
è¿”å›ç³»ç»Ÿè¿è¡Œä¿¡æ¯ï¼š
```json
{
  "go_version": "go1.24.3",
  "goroutines": 15,
  "cpu_cores": 8,
  "memory": {
    "alloc_mb": 50,
    "sys_mb": 100
  },
  "judge_stats": {
    "active_judges": 1,
    "available_slots": 1
  },
  "cache_stats": {
    "cache_size": 100,
    "usage_percent": 25.5
  }
}
```

#### å°±ç»ªæ£€æŸ¥ï¼ˆK8sï¼‰
```bash
GET /readiness
```

#### å­˜æ´»æ£€æŸ¥ï¼ˆK8sï¼‰
```bash
GET /liveness
```

**ä»£ç ä½ç½®**ï¼š
- `internal/service/metrics.go` - ç»Ÿè®¡æ¨¡å—
- `internal/handler/monitor.go` - ç›‘æ§API

---

### 7. **é…ç½®æ–‡ä»¶æ”¯æŒ** â­â­â­â­

**åŠŸèƒ½è¯´æ˜**ï¼š
- æ”¯æŒé€šè¿‡é…ç½®æ–‡ä»¶è°ƒæ•´è¯„æµ‹å‚æ•°
- æ”¯æŒç¯å¢ƒå˜é‡è¦†ç›–
- ä¾¿äºä¸åŒç¯å¢ƒçš„éƒ¨ç½²

**é…ç½®æ–‡ä»¶**ï¼š`config/config.yaml`

```yaml
# è¯„æµ‹æœºé…ç½®
judge:
  max_concurrent: 2              # æœ€å¤§å¹¶å‘è¯„æµ‹æ•°
  max_timeout: 300               # å•ä¸ªè¯„æµ‹æœ€å¤§è¶…æ—¶ï¼ˆç§’ï¼‰
  temp_dir: ""                   # ä¸´æ—¶ç›®å½•
  enable_early_stop: false       # é‡åˆ°é”™è¯¯æ˜¯å¦æå‰ç»ˆæ­¢
  max_output_size: 10485760      # æœ€å¤§è¾“å‡ºå¤§å°ï¼ˆ10MBï¼‰
  enable_compile_cache: false    # æ˜¯å¦å¯ç”¨ç¼–è¯‘ç¼“å­˜

# ç¼“å­˜é…ç½®
cache:
  test_case_ttl: 1800           # æµ‹è¯•ç”¨ä¾‹ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰
  max_disk_usage: 2147483648    # æœ€å¤§ç£ç›˜ä½¿ç”¨ï¼ˆ2GBï¼‰
  clean_frequency: 600          # æ¸…ç†é¢‘ç‡ï¼ˆç§’ï¼‰
```

**ä»£ç ä½ç½®**ï¼š`internal/conf/judge_config.go`

---

### 8. **æå‰ç»ˆæ­¢ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰** â­â­â­

**åŠŸèƒ½è¯´æ˜**ï¼š
- å½“æŸä¸ªæµ‹è¯•ç‚¹å¤±è´¥æ—¶ï¼Œå¯é€‰æ‹©æ˜¯å¦ç»§ç»­è¿è¡Œåç»­æµ‹è¯•ç‚¹
- èŠ‚çœè¯„æµ‹æ—¶é—´
- é€‚ç”¨äºåªéœ€è¦çŸ¥é“æ˜¯å¦å…¨éƒ¨é€šè¿‡çš„åœºæ™¯

**é…ç½®**ï¼š
```yaml
judge:
  enable_early_stop: true  # å¯ç”¨æå‰ç»ˆæ­¢
```

**ä»£ç å®ç°**ï¼š
```go
// å¦‚æœä¸æ˜¯ACä¸”å¯ç”¨äº†æå‰ç»ˆæ­¢ï¼Œåˆ™è·³å‡ºå¾ªç¯
if testCaseResult.Status != model.StatusAC && config.EnableEarlyStop {
    break
}
```

---

### 9. **è¾“å‡ºå¤§å°é™åˆ¶** â­â­â­

**åŠŸèƒ½è¯´æ˜**ï¼š
- é™åˆ¶ç¨‹åºè¾“å‡ºçš„æœ€å¤§å¤§å°
- é˜²æ­¢æ¶æ„ä»£ç è¾“å‡ºå¤§é‡æ•°æ®
- é¿å…å†…å­˜æº¢å‡º

**é…ç½®**ï¼š
```yaml
judge:
  max_output_size: 10485760  # 10MB
```

---

## ğŸ“Š ä½¿ç”¨å¯¹æ¯”

### åŸç‰ˆ API è°ƒç”¨
```bash
POST /api/v1/task/add
```

### æ”¹è¿›ç‰ˆ API è°ƒç”¨ï¼ˆæ¨èï¼‰
```bash
POST /api/v1/task/add
```

**ä½¿ç”¨æ”¹è¿›ç‰ˆçš„ä¼˜åŠ¿**ï¼š
1. âœ… æ­£ç¡®çš„è¯„æµ‹ç»“æœçŠ¶æ€
2. âœ… å‡†ç¡®çš„æ—¶é—´å’Œå†…å­˜ç»Ÿè®¡
3. âœ… å¹¶å‘æ§åˆ¶ï¼Œé¿å…èµ„æºç«äº‰
4. âœ… è¶…æ—¶ä¿æŠ¤ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡
5. âœ… å®Œå–„çš„é”™è¯¯å¤„ç†
6. âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•

---

## ğŸ”§ è¿ç§»æŒ‡å—

### æ­¥éª¤1ï¼šæ›´æ–°é…ç½®æ–‡ä»¶
```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim config/config.yaml

# æ ¹æ®æœåŠ¡å™¨é…ç½®è°ƒæ•´å¹¶å‘æ•°
judge:
  max_concurrent: 2  # å»ºè®®è®¾ç½®ä¸ºCPUæ ¸å¿ƒæ•°
```

### æ­¥éª¤2ï¼šæ›´æ–°ä»£ç å¼•ç”¨
åœ¨ `internal/handler/task.go` ä¸­ï¼š

```go
// åŸç‰ˆè°ƒç”¨
judgeResult, err := service.AddTask(c, req)

// æ”¹ä¸ºæ”¹è¿›ç‰ˆ
judgeResult, err := service.AddTaskImproved(c, req)
```

### æ­¥éª¤3ï¼šé‡å¯æœåŠ¡
```bash
# é‡æ–°ç¼–è¯‘
make build

# é‡å¯æœåŠ¡
./output/server
```

### æ­¥éª¤4ï¼šéªŒè¯æ”¹è¿›
```bash
# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:53333/health

# æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
curl http://localhost:53333/metrics

# æäº¤è¯„æµ‹ä»»åŠ¡
curl -X POST http://localhost:53333/api/v1/task/add \
  -H "Content-Type: application/json" \
  -d @test_request.json
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å¹¶å‘æ•°è®¾ç½®
- **å•æ ¸CPU**ï¼šè®¾ç½®ä¸º 1
- **åŒæ ¸CPU**ï¼šè®¾ç½®ä¸º 2
- **å››æ ¸CPU**ï¼šè®¾ç½®ä¸º 2-4
- **å…«æ ¸åŠä»¥ä¸Š**ï¼šè®¾ç½®ä¸º 4-8

### 2. ç¼“å­˜é…ç½®
- **å°è§„æ¨¡**ï¼ˆ<100é¢˜ï¼‰ï¼š1GB ç¼“å­˜
- **ä¸­ç­‰è§„æ¨¡**ï¼ˆ100-500é¢˜ï¼‰ï¼š2GB ç¼“å­˜
- **å¤§è§„æ¨¡**ï¼ˆ>500é¢˜ï¼‰ï¼š4GB+ ç¼“å­˜

### 3. è¶…æ—¶è®¾ç½®
- **ç®€å•é¢˜ç›®**ï¼š60-120ç§’
- **ä¸­ç­‰é¢˜ç›®**ï¼š120-300ç§’
- **å¤æ‚é¢˜ç›®**ï¼š300-600ç§’

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: è¯„æµ‹é˜Ÿåˆ—å·²æ»¡æ€ä¹ˆåŠï¼Ÿ
**A**: å¢åŠ  `max_concurrent` é…ç½®å€¼ï¼Œæˆ–è€…ç­‰å¾…å½“å‰è¯„æµ‹å®Œæˆã€‚

### Q2: è¯„æµ‹è¶…æ—¶æ€ä¹ˆåŠï¼Ÿ
**A**: å¢åŠ  `max_timeout` é…ç½®å€¼ï¼Œæˆ–è€…ä¼˜åŒ–æµ‹è¯•ç”¨ä¾‹æ•°é‡ã€‚

### Q3: å†…å­˜ä½¿ç”¨è¿‡é«˜æ€ä¹ˆåŠï¼Ÿ
**A**: 
- å‡å°‘ `max_concurrent` å€¼
- å‡å°‘ `cache.max_disk_usage` å€¼
- å¯ç”¨ `enable_early_stop`

### Q4: å¦‚ä½•æŸ¥çœ‹è¯„æµ‹ç»Ÿè®¡ï¼Ÿ
**A**: è®¿é—® `/metrics` ç«¯ç‚¹æŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯ã€‚

---

## ğŸ“ æ”¹è¿›æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | è¯´æ˜ | ä¼˜å…ˆçº§ |
|------|------|--------|
| `internal/service/task_improved.go` | æ”¹è¿›ç‰ˆè¯„æµ‹é€»è¾‘ | â­â­â­â­â­ |
| `internal/service/metrics.go` | ç»Ÿè®¡ç›‘æ§æ¨¡å— | â­â­â­â­ |
| `internal/handler/monitor.go` | ç›‘æ§API | â­â­â­â­ |
| `internal/conf/judge_config.go` | é…ç½®ç®¡ç† | â­â­â­ |
| `internal/server/route.go` | è·¯ç”±é…ç½®ï¼ˆå·²æ›´æ–°ï¼‰ | â­â­â­ |
| `config/config.yaml` | é…ç½®æ–‡ä»¶ï¼ˆå·²æ›´æ–°ï¼‰ | â­â­â­ |

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›ç‚¹
1. âœ… **ä¿®å¤çŠ¶æ€è®¡ç®—é”™è¯¯** - æœ€é‡è¦çš„bugä¿®å¤
2. âœ… **æ·»åŠ å¹¶å‘æ§åˆ¶** - ä¿è¯è¯„æµ‹å‡†ç¡®æ€§
3. âœ… **æ·»åŠ è¶…æ—¶ä¿æŠ¤** - é¿å…è¯·æ±‚é˜»å¡
4. âœ… **å®Œå–„é”™è¯¯å¤„ç†** - æé«˜ç³»ç»Ÿç¨³å®šæ€§
5. âœ… **å¢åŠ ç›‘æ§ç»Ÿè®¡** - ä¾¿äºè¿ç»´ç®¡ç†

### å»ºè®®ä½¿ç”¨æ–¹å¼
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šä½¿ç”¨ `AddTaskImproved`ï¼Œå¯ç”¨æ‰€æœ‰ç›‘æ§
- **å¼€å‘ç¯å¢ƒ**ï¼šå¯ä»¥ä½¿ç”¨åŸç‰ˆæˆ–æ”¹è¿›ç‰ˆ
- **æµ‹è¯•ç¯å¢ƒ**ï¼šä½¿ç”¨æ”¹è¿›ç‰ˆï¼Œä¾¿äºå‘ç°é—®é¢˜

### åç»­ä¼˜åŒ–æ–¹å‘
1. æ”¯æŒå¼‚æ­¥è¯„æµ‹ï¼ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼‰
2. æ”¯æŒåˆ†å¸ƒå¼è¯„æµ‹ï¼ˆå¤šæœºéƒ¨ç½²ï¼‰
3. æ·»åŠ è¯„æµ‹ç»“æœæŒä¹…åŒ–
4. æ”¯æŒæ›´å¤šç¼–ç¨‹è¯­è¨€
5. ä¼˜åŒ–ç¼–è¯‘ç¼“å­˜æœºåˆ¶

